# Marzipan - ç§»æ¤iOSåˆ°mac

ä¼´éšç€masOS Mojaveçš„åˆ°æ¥ï¼ŒAppleæ­£åœ¨å¢åŠ å¯¹åœ¨macOSä¸Šè¿è¡ŒUIKitåº”ç”¨ç¨‹åºçš„æ”¯æŒï¼Œè€Œæ— éœ€åœ¨AppKitä¸­é‡å†™UIã€‚è™½ç„¶è¿˜æ²¡æ­£å¼å¼€å§‹å¯¹ç¬¬ä¸‰æ–¹å¼€å‘äººå‘˜æ”¯æŒï¼Œä½†è®©æˆ‘ä»¬æ¥æ¢è®¨2019å¹´ä¼šå‘ç”Ÿä»€ä¹ˆä»¥åŠåœ¨ä»Šå¤©å°è¯•ä¸€ä¸‹ã€‚



è¿™ç‰‡æ–‡ç« åŸºäºæˆ‘åœ¨try! Swift New Yorkå¤§ä¼šä¸Šçš„â€œHacking Marzipanâ€ã€‚[å¹»ç¯ç‰‡åœ¨è¿™é‡Œ](https://speakerdeck.com/steipete/hacking-marzipan).



[![IMAGE ALT TEXT HERE](https://img.youtube.com/vi/2OuQarA0a7I/0.jpg)](https://youtu.be/2OuQarA0a7I)	



*âš ï¸*è­¦å‘Š: æ·±æŒ–iOSMacå¹³å°éœ€è¦ç ´è§£Macï¼Œä¼šå¼±åŒ–Macçš„å®‰å…¨æ€§ï¼Œå› æ­¤æ‚¨åº”è¯¥ä½¿ç”¨å…¶ä»–å•ç‹¬çš„æœºå™¨æ¥æ¢ç´¢è¿™é¡¹æ–°æŠ€æœ¯ã€‚æš‚æ—¶ä¸è¦åˆ†å‘iOSMacåº”ç”¨ç¨‹åº - åº•å±‚æ¡†æ¶ä»ç„¶æ˜¯ç§æœ‰çš„ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚



## ä»€ä¹ˆæ˜¯Marzipanï¼Ÿ

Marzipanæ˜¯Appleé¢å‘Macçš„æ–°iOSåº”ç”¨å±‚ã€‚å®ƒåˆç†çš„ä½¿ç”¨UIKitå’Œå¤§å¤šæ•°ç›¸å…³iOSæ¡†æ¶ç¼–å†™çš„åº”ç”¨ç¨‹åºã€‚ä½ å·²ç»å¯ä»¥åœ¨Macä¸Šè¿è¡ŒiOSåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”ä½ å·²ç»é€šè¿‡æ¨¡æ‹Ÿå™¨æ‰§è¡Œäº†å¤šå¹´ã€‚



Marzipanåœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯æ¨¡æ‹Ÿå™¨çš„æ¼”å˜ã€‚ä½†æ˜¯å®ƒä¸ä½¿ç”¨æ¨¡æ‹Ÿå™¨çš„æ¶æ„ï¼›å®ƒé›†æˆå¾—æ›´æ·±å…¥ï¼Œå¹¶ä¸”åŒ…æ‹¬æ”¯æŒåœ¨çª—å£æ·»åŠ æŒ‰é’®ï¼Œèœå•æ ï¼Œç„¦ç‚¹æç¤ºç­‰ç­‰ã€‚è¿˜æœ‰æ‹–æ”¾æ“ä½œã€‚



æœ‰è¶£çš„æ˜¯ï¼šMarzipanæ‹¥æœ‰size classeså’Œç¼©æ”¾å› å­ä¸º0.77 - æ‰€æœ‰çš„ç»˜åˆ¶å˜å¾—æ›´å°æ¥é€‚åº”Macã€‚



## å†å²åŠæ—¶é—´è½´

æ—¶è‡³ä»Šæ—¥ï¼ŒUIKitå¹¶ä¸æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œåœ¨ä¸æ˜¯ä¸ºå®ƒè®¾è®¡çš„å¹³å°ä¸Šã€‚Facebookæœ‰ä¸€ä¸ªé—­æºçš„å†…éƒ¨é¡¹ç›®å«[OSMeta](https://twitter.com/steipete/status/931639019179528192),å®ƒå‡ ä¹é‡å†™äº†æ•´ä¸ªiOSå¹³å°ã€‚å¾®è½¯æ‹¥æœ‰ä¸€ä¸ªå«islandwoodçš„é¡¹ç›®ï¼Œä¹Ÿå«åš[Windows Bridge for iOS](https://developer.microsoft.com/en-us/windows/bridges/ios).åœ¨Githubä¸Šä½ ä¹Ÿå¯ä»¥æ‰¾åˆ°ä¸€äº›åƒ[Chameleon Project](http://chameleonproject.org/)çš„å°è¯•è€…ã€‚ç„¶åï¼ŒUIKitå°±åƒå¤´å·¨å¤§çš„é‡å…½ï¼Œå®é™…ä¸Šä¹Ÿåªæœ‰Appleå¯ä»¥å®Œæ•´ç§»æ¤å®ƒã€‚



å½“Mark Gurmanäº2017å¹´æœ«åœ¨[Bloomberg](https://www.bloomberg.com/news/articles/2017-12-20/apple-is-said-to-have-plan-to-combine-iphone-ipad-and-mac-apps)æ³„éœ²å‡ºå…³äºMarzipançš„æ¶ˆæ¯æ—¶ï¼Œå‡ ä¹æ²¡æœ‰äººç›¸ä¿¡AppleçœŸçš„ä¼šæ²¿ç€è¿™æ¡è·¯èµ°ä¸‹å»ã€‚ç”šè‡³ä»–ä»¬è‡ªå·±çš„å·¥ç¨‹å¸ˆä¹Ÿå¾ˆæƒŠè®¶å½“Craig Federighié€‰æ‹©åœ¨2018å¹´WWDCä¸Šå±•ç¤ºäº†ä¸€æ®µç›¸å…³å†…å®¹[[sneak peek at WWDC 2018](https://9to5mac.com/2018/06/04/apple-gives-a-sneak-peek-at-multi-year-project-to-bring-uikit-ios-apps-to-the-mac/)](https://9to5mac.com/2018/06/04/apple-gives-a-sneak-peek-at-multi-year-project-to-bring-uikit-ios-apps-to-the-mac/)ï¼Œå› ä¸ºç›´åˆ°2019å¹´æœ«macOS 10.15æ‰ä¼šæœ‰ç¬¬ä¸‰æ–¹å¼€å‘äººå‘˜çš„å®˜æ–¹SDKã€‚



## iOSMacçš„æ¶æ„

![img](https://pspdfkit.com/images/blog/2018/marzipan-iosmac/marzipan-features-wwdc2018-251359d9.png)



è¿è¡ŒiOSMacåº”ç”¨ç¨‹åºå°†ç”Ÿæˆæ•´ä¸ªè¿›ç¨‹åˆ—è¡¨ã€‚æœ‰ä¸€ä¸ªAppKit shellæ˜¾ç¤ºUIKitåº”ç”¨ç¨‹åºï¼Œç„¶åæ˜¯UIKitSystem.appï¼Œè¿™æ˜¯Macçš„FrontBoardç‰ˆæœ¬ï¼š

- /Applications/**VoiceMemos.app**
- /System/iOSSupport/System/Library/PrivateFrameworks/ VoiceMemos.framework/Support/**voicememod**
- /System/Library/CoreServices/**UIKitSystem.app**
- /System/Library/PrivateFrameworks/UIKitHostAppServices.framework/ Versions/A/XPCServices/**UIKitHostApp.xpc** (disguised)



å¦‚æœä½ æƒ³çŸ¥é“å¾—æ›´å¤šï¼Œçœ‹çœ‹Adam Demasiå†™çš„ä¸€ç¯‡[å…³äºiOSMacæ¶æ„å†…éƒ¨](https://kirb.me/2018/06/07/iosmac-research.html)çš„æ–‡ç« ã€‚



## å½“å‰ç ´è§£çš„æ¦‚å†µ

Appleæ­£åœ¨åˆ†é˜¶æ®µæµ‹è¯•è¿™ä¸ªæ–°å¹³å°ã€‚ macOS Mojaveåœ¨iOSMacä¸Šè¿è¡Œæ–°çš„Appleæä¾›çš„åº”ç”¨ç¨‹åºï¼Œæä¾›ç¬¬1é˜¶æ®µã€‚é€šè¿‡ç¬¬2é˜¶æ®µï¼Œå¼€å‘äººå‘˜å¯ä»¥è®¿é—®è¯¥å¹³å°ã€‚ä½†æ˜¯ï¼Œæœ‰å„ç§æ–¹æ³•å¯ä»¥è§£å†³Appleç›®å‰å¯¹Marzipançš„é™åˆ¶ã€‚



### [marzipan_hook](https://github.com/justMaku/marzipan_hook)

MichaÅ‚ KaÅ‚uÅ¼nyçš„ç ´è§£æ˜¯ç¬¬ä¸€ä¸ªåŒæ—¶ä¹Ÿå¾ˆå€¼å¾—æåŠçš„å…¶ä¸­ä¹‹ä¸€ã€‚ä»–åˆ©ç”¨ğŸçš„iOSMacåº”ç”¨ï¼Œæ³¨å…¥ä½ çš„ä»£ç åˆ°ä¸€ä¸ªåº”ç”¨é‡Œå°†å®ƒå˜æˆä½ è‡ªå·±çš„ï¼Œå°±åƒç—…æ¯’ä¾µå…¥äº†ç»†èƒï¼Œè®©ç»†èƒå¤±å»å…¶åŸæ¥çš„ä½œç”¨ã€‚è¿™ä¸æ˜¯ä¸€ç§å¯æ‰©å±•çš„æ–¹å¼ï¼Œä½†æ˜¯KaÅ‚uÅ¼nyæå…·åˆ›æ„ã€‚



## [MarzipanPlatter](https://github.com/biscuitehh/MarzipanPlatter)

æ—©æœŸï¼ŒMarzipanPlatteræ˜¯å°†iOSåº”ç”¨ç¨‹åºè½¬æ¢ä¸ºmacOSçš„æœ€ä½³é€‰æ‹©ï¼Œæˆ‘æˆåŠŸåœ°å°†Mojave Beta 1ä¸Šçš„PDF Viewerç§»æ¤åˆ°Macä¸Šã€‚ç„¶è€Œï¼Œæˆ‘çš„æ–¹æ³•æ··åˆäº†UIKitå’ŒAppKitï¼Œè¿™æ˜¯æœ‰ç¼ºé™·çš„(ä½†æ˜¯[ä¸Šäº†å¤´æ¡](https://9to5mac.com/2018/06/13/marzipan-in-mojave-porting-ios-apps-to-macos/))

> Got [@pdfviewerapp](https://twitter.com/pdfviewerapp?ref_src=twsrc%5Etfw) running on Marzipan ğŸ¤¯
>
> Featuring  inline video, page curl, popovers, scrolling, text selection, inline  forms, adding text, color inspector, search, editing documents - almost  everything works. Took me half a day. Project is 1MLOC ObjC/C++.
>
> Major props to Apple! [pic.twitter.com/1ofpe5AqyM](https://t.co/1ofpe5AqyM)
>
> â€” Peter Steinberger (@steipete) 
>
> June 11, 2018



## [marzipanify](https://github.com/steventroughtonsmith/marzipanify)

![img](https://pspdfkit.com/images/blog/2018/marzipan-iosmac/marzipanify-70dc4ad3.jpg)



[Steven Troughton-Smith ](https://twitter.com/stroughtonsmith)æä¾›æœ€å®Œæ•´çš„è½¬åŒ–å·¥å…· [marzipanify](https://github.com/steventroughtonsmith/marzipanify)ã€‚è¿™æ˜¯ç›®å‰ç§»æ¤åº”ç”¨çš„æœ€ä½³æ–¹å¼ã€‚å®ƒåŸºæœ¬ä¸Šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- æ·»åŠ  â€œMarzipan Glueâ€
- è´´ä¸ª Info.plist
- ä¿®æ”¹Machå¤´æ–‡ä»¶
- æ·»åŠ ç§ç”¨çš„iOSMac entitlements



æˆ‘ä»¬å°†åœ¨æœ¬æ–‡ä¸­ä½¿ç”¨marzipanifyã€‚å¤§åŠ›å®£æ‰¬Stevençš„è¿™ä¸ªç¥å¥‡çš„å·¥å…·ã€‚å¦‚æœä½ å‘ç°å®ƒå¾ˆæœ‰ç”¨ï¼Œå¯ä»¥è€ƒè™‘åœ¨Patreon [supporting him on Patreon](https://www.patreon.com/steventroughtonsmith)ä¸Šæ”¯æŒä»–ã€‚



# å…³æ‰ä½ çš„å®‰å…¨é˜²æŠ¤ ğŸ™€

ğŸæ—©å·²é”äº†å¾ˆå¤šåŠŸèƒ½ï¼Œæ‰€ä»¥ä½ ä¸èƒ½å¼€ç®±å³ç”¨çš„åˆ¶ä½œiOSMacåº”ç”¨ - è‡³å°‘ä½ è¦ç ´è§£ä¸€ä¸‹ã€‚åˆ°è¿™é‡Œæˆ‘ä»¬æ‰€è°ˆåŠçš„ç ´è§£å°±æ˜¯æˆ‘ä»¬éœ€è¦å…³æ‰ğŸç³»ç»Ÿå†…ç½®çš„ä¿æŠ¤æœºåˆ¶ã€‚è¿™ä¸æ˜¯ä½ æ—¥å¸¸ä½¿ç”¨ä¸­éœ€è¦æ¶‰åŠçš„åœ°æ–¹ï¼Œæˆ‘ä¹‹å‰å·²ç»æåŠè¿‡ï¼Œä½ æœ€å¥½ä½¿ç”¨å¦ä¸€å°æœºå™¨æ¥ä½“éªŒå®ƒã€‚

```shell
sudo csrutil disable
sudo nvram boot-args=â€œamfi_get_out_of_my_way=0x1â€
```

è¿™é‡Œæ‰€éœ€çš„ç ´è§£ï¼Œä½ ä¹Ÿæ˜¯éœ€è¦ç¦ç”¨æ²™ç›’ã€‚ğŸæ§åˆ¶äº†å“ªäº›åº”ç”¨å¯ä»¥è·å¾—iOSMacçš„entitlementï¼Œå¦‚æœä½ æ²¡æœ‰é‚£é­”æœ¯èˆ¬çš„amfi_get_out_of_my_way å¯åŠ¨å‚æ•°ï¼Œä½ çš„ä½“éªŒå°†æå‰ç»ˆæ­¢ã€‚ï¼ˆamfi æ˜¯ AppleMobileFileIntegrityçš„ç¼©å†™ï¼‰ã€‚



## è™šæ‹Ÿæœºå¹¶ä¸æ˜¯æ€»èƒ½è¡Œ

iOSMac å¹³å°éœ€è¦GPUåŠ é€Ÿå™¨ï¼Œå¹¶åœ¨å…¶ä¸å¯ç”¨æ—¶ç®€å•çš„é€€å‡ºã€‚

**æ›´æ–°**ï¼šè‹¹æœä¼¼ä¹æ­£åœ¨ç§¯æç ”ç©¶è¿™ä¸€ç¼ºé™·ã€‚ä»Mojave Beta 11å¼€å§‹ï¼Œä¸€äº›åº”ç”¨ï¼ˆåŒ…æ‹¬ç”¨äºMacçš„Homeå’ŒPDF Viewerï¼‰ç°åœ¨åœ¨VMå†…è¿è¡Œï¼Œè€ŒNewsè¿™ä¸ªåº”ç”¨ä»ç„¶æ— æ³•åŠ è½½ã€‚å‘[Michael Thomas](https://twitter.com/NSBiscuit)è‡´æ•¬ï¼Œå‘Šè¯‰æˆ‘è¿™ä¸ªå˜åŒ–ï¼

![img](https://pspdfkit.com/images/blog/2018/marzipan-iosmac/mojave-vm-1c70d9d6.png)

## ç§»æ¤PDF Viewer åˆ°Mac

[PDF Viewer](http://pdfviewer.io)æ˜¯ä¸€ä¸ªç›¸å½“å¤æ‚çš„iOSåº”ç”¨ç¨‹åºï¼Œç”¨Cï¼ŒC ++ï¼ŒObjective-Cå’ŒSwiftç¼–å†™ã€‚å®ƒåŸºäº[PSPDFKit](https://pspdfkit.com/)ï¼Œå®ƒæœ¬èº«æœ‰è¶…è¿‡ä¸€ç™¾ä¸‡è¡Œä»£ç ï¼Œè‡ª2010å¹´ä»¥æ¥ä¸€ç›´åœ¨å¼€å‘ä¸­ã€‚è¿™ä½¿å¾—ä¸€ä¸ªéå¸¸å¼•äººæ³¨ç›®çš„æµ‹è¯•ç”¨ä¾‹ã€‚



### æ­¥éª¤ä¸€ï¼šæœ€å°çš„deployment target = iOS 12

æ‚¨éœ€è¦ç¡®ä¿é¡¹ç›®çš„æœ€å°éƒ¨ç½²ç›®æ ‡ï¼Œå¹¶ä¸”æ‰€æœ‰ç›¸å…³æ¡†æ¶éƒ½è®¾ç½®ä¸ºiOS 12.ä»…å½“è®¾ç½®äº†iOS 12æ—¶ï¼Œé“¾æ¥å™¨æ‰ä¼šå‘å‡ºLC_BUILD_VERSIONæ ‡å¿—è€Œä¸æ˜¯æ—©æœŸçš„LC_BUILD_VERSION_MIN_MACOSï¼Œè¿™æ˜¯iOSMacåŠ è½½æ­£ç¡®ä¾èµ–é¡¹æ‰€å¿…éœ€çš„ã€‚ marzipanifyä¼šå°è¯•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†å®ƒä¼šé€ æˆå¾ˆå¤šéº»çƒ¦ï¼Œä½ æœ€ç»ˆå¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæ— æ³•å¯åŠ¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™æ˜¯ä½¿ç”¨ä¸€ä¸ªxcconfigæ–‡ä»¶æœ‰ä»·å€¼çš„åœ°æ–¹ï¼š

![img](https://pspdfkit.com/images/blog/2018/marzipan-iosmac/deployment-targets-78602a79.png)



### æ­¥éª¤äºŒï¼š ç§»é™¤æ¡†æ¶

åˆ é™¤ä½¿ç”¨å·²å¼ƒç”¨çš„ä»£ç ã€‚ iOSMacæ˜¯ä¸€ä¸ªæ–°å¹³å°ï¼Œä¸åŒ…æ‹¬å·²å¼ƒç”¨çš„ç±»ã€‚æœ€æœ‰å¯èƒ½å‡ºé—®é¢˜çš„æ˜¯UIWebViewï¼Œå°½ç®¡ç°åœ¨WKWebViewå·²ä½¿ç”¨å¤šå¹´ï¼Œä½†å®ƒä»ç„¶æ— å¤„ä¸åœ¨ã€‚å¤§å¤šæ•°æ¡†æ¶éƒ½å¯ç”¨ï¼Œé™¤éå°†å®ƒä»¬ç§»æ¤åˆ°Macæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

- `SafariServices.framework` (`SFSafariViewController` does not make sense on the Mac; use openURL)
- `CoreTelephony.framework` (`CTTelephonyNetworkInfo` especially)
- `Social.framework` (`SLComposeViewController`)
- `MessageUI.framework` (`MFMailComposeViewController`)
- `OpenGLES.framework` (rewritten to Metal)
- `AddressBook.framework` (too new?)



å¦‚æœå­˜åœ¨æ¡†æ¶ï¼Œåˆ™æ— æ³•ä¿è¯æ‰€æœ‰symbolséƒ½å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯UIMarkupTextPrintFormatterï¼Œå®ƒè‡ªiOS 4.2ä»¥æ¥ä¸€ç›´æ˜¯UIKitçš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸åœ¨iOSMacä¸­ã€‚å¯åŠ¨æ—¶ï¼Œæ‚¨å°†å¾ˆå¿«çœ‹åˆ°ç¼ºå°‘å“ªäº›symbolsï¼š

```shell
./PDFViewerMac

dyld: Symbol not found: _OBJC_CLASS_$_UIMarkupTextPrintFormatter
  Referenced from: /marzipanify/PDFViewer.app/
                   Contents/MacOS/./PDFViewer (which was built for Mac OS X 12.0)

  Expected in: /System/iOSSupport/System/Library/Frameworks/UIKit.framework/UIKit
 in /marzipanify/PDFViewer.app/Contents/MacOS/./PDFViewer
```

ä»¥ä¸‹æ˜¯ä¸å®Œæ•´çš„symbolsåˆ—è¡¨:

- `UIImpactFeedbackGenerator` (your Mac has no way to generate haptic feedback, but this should be a NOP instead)
- `UIPrintInfo` (probably related to `UIWebView` missing)
- `[UIViewController setNeedsUpdateOfHomeIndicatorAutoHidden:]`(Mojaveâ€™s UIKit branch might have been cut before the iPhone X branch was merged?)
- `UIDocumentBrowser` (the document browser concept makes no sense on the Mac)
- `PHCachingImageManager` (`Photos.framework` is a problem in and of itself)



æˆ‘ä»¬é€‰æ‹©äº†ä¸€ç§æ··åˆæ–¹æ³•æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œæ–¹æ³•æ˜¯åœ¨ä¸€ä¸ªå°çš„èƒ¶æ°´å¼çš„æ–‡ä»¶ä¸­æ·»åŠ ä¸€äº›ç¼ºå¤±çš„symbolsï¼š

```objective-c
@interface UIViewController (MarzipanSupport)
- (void)setNeedsUpdateOfHomeIndicatorAutoHidden;
@end

@implementation UIViewController (MarzipanSupport)
- (void)setNeedsUpdateOfHomeIndicatorAutoHidden {}
@end
```



### æ­¥éª¤ä¸‰ï¼šè½¬æ¢å’Œè‡ªåŠ¨åŒ–

ç”±äºä½¿ç”¨marzipanifyéœ€è¦é¢å¤–çš„æ­¥éª¤ï¼Œæˆ‘çš„å»ºè®®æ˜¯è‡ªåŠ¨åŒ–è½¬æ¢è¿‡ç¨‹ã€‚æˆ‘æ²¡æœ‰å°è¯•å°†è‡ªåŠ¨åŒ–è„šæœ¬æ·»åŠ ä¸ºXcodeæ„å»ºè®¾ç½®ï¼Œå› ä¸ºå°†å…¶ä½œä¸ºä¸€ä¸ªå°è„šæœ¬è¿è¡Œä¼¼ä¹å·²ç»è¶³å¤Ÿäº†ã€‚ LLDBå‡†å¤‡å°±ç»ªåï¼Œé”®å…¥runï¼š

```shell
#!/bin/bash
rm -rf PDFViewer.app
cp -r /Users/steipete/Builds/PDFViewer-.../Build/Products/Debug-iphonesimulator/PDFViewer.app .
./marzipanify PDFViewer.app
rm Entitlements*
lldb PDFViewer.app
```



### æ­¥éª¤å››ï¼šç™½åå•ä¸­çš„Swift

è¿™ä¸ªèŠ±äº†æˆ‘å¾ˆé•¿æ—¶é—´æ‰æ˜ç™½ã€‚ç³»ç»ŸæŠ±æ€¨Swiftæ”¯æŒåº“åœ¨é‚£é‡Œä½†ä¸æ˜¯ä¸ºiOSMacæ„å»ºçš„ã€‚æ‰€ä»¥æˆ‘åªæ˜¯ä»/ System / Library / PrivateFrameworks / Swiftæ‰‹åŠ¨å¤åˆ¶å®ƒä»¬ã€‚ç„¶è€Œï¼Œä¸€æ—¦æˆ‘è¿™æ ·åšï¼Œå‡ ä¹ä¸èµ·ä½œç”¨ï¼Œå¹¶ä¸”å‡ºç°ä¸æ–­å´©æºƒçš„æƒ…å†µä¸å¥‡æ€ªçš„è¿‡åº¦é‡Šæ”¾é—®é¢˜ã€‚æˆ‘åœ¨è¿™é‡Œä½¿ç”¨Swift 4.2ï¼Œä½†/ System / Library / PrivateFrameworks / Swiftä¸­çš„Swiftæ”¯æŒåº“æ˜¯æ—§ç‰ˆæœ¬ï¼Œå¹¶ä¸”åœ¨æœ€è¿‘çš„æŸä¸ªæ—¶å€™ï¼Œ[è°ƒç”¨çº¦å®šå·²è¢«æ›´æ”¹](https://www.jessesquires.com/blog/swifts-new-calling-convention/)ã€‚å› æ­¤ï¼Œè™½ç„¶å¯¹Objective-Cæ¡¥æ¥ç±»çš„åŸºæœ¬è°ƒç”¨ä»ç„¶æœ‰æ•ˆï¼Œä½†æ˜¯ä¸€æ—¦æˆ‘æ‰§è¡Œäº†æ›´å¤æ‚çš„è°ƒç”¨ï¼Œå°±ä¼šè°ƒç”¨Bundle.main.bundleURLï¼š

```shell
: Library not loaded: @rpath/libswiftAVFoundation.dylib
  Referenced from: /marzipanify/PDFViewerMac.app/Contents/MacOS/PDFViewerMac

  Reason: no suitable image found.  Did find:
  /marzipanify/PDFViewerMac.app/Contents/MacOS/../Frameworks/libswiftAVFoundation.dylib: mach-o, but not built for iOSMac

Process 78797 stopped
* thread #1, stop reason = signal SIGABRT
    frame #0: 0x000000010523a162 dyld`__abort_with_payload + 10
dyld`__abort_with_payload:
->  0x10523a162 <+10>: jae    0x10523a16c               ; <+20>
Target 0: (PDFViewerMac) stopped.
```



ç¼–è¾‘ /System/iOSSupport/dyld/macOS-whitelist.txt` and append `/Applications/PDFViewerMac.app/Contents/MacOS ï¼ˆæ›¿æ¢è°ƒä½ çš„binaryçš„åœ°å€ï¼‰ã€‚

å¦‚æœä»»ä½•ä¾èµ–é¡¹å°†AppKitåŠ è½½åˆ°æ‚¨çš„è¿›ç¨‹ä¸­ï¼ŒiOSMacå°†æ‹’ç»åŠ è½½ï¼Œé™¤éæ‚¨é€šè¿‡LLDBè¿è¡Œå®ƒã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç†ç”±å°†AppKitåˆ—å…¥é»‘åå•ï¼šå®ƒä¿®æ”¹/ä¸è®¸å¤šUIKitå†…éƒ¨å†²çªï¼Œä½ çš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šåœ¨å¯åŠ¨æ—¶å´©æºƒæˆ–åªæ˜¯ä¸æ¸²æŸ“ä»»ä½•å­—ä½“ã€‚ ï¼ˆå¦‚æœä½ åœ¨ [UILabel ns_widgetType] ä¸Šé‡åˆ°å´©æºƒï¼Œä½ ä¼šçŸ¥é“åŸå› ã€‚ï¼‰

```shell
*** Terminating app due to uncaught exception 'NSInternalInconsistencyException', 
    reason: 'AppKit is getting loaded into a disallowed context'

*** First throw call stack:
(
  0   CoreFoundation                      0x00007fff4b49343d __exceptionPreprocess + 256
  1   libobjc.A.dylib                     0x00007fff772e1720 objc_exception_throw + 48
  2   CoreFoundation                      0x00007fff4b4ae08e +[NSException raise:format:arguments:] + 98
  3   Foundation                          0x00007fff4d82955d -[NSAssertionHandler 
                                          handleFailureInMethod:object:file:lineNumber:description:] + 194
  4   AppKit                              0x00007fff489175cb +[NSApplication load] + 672
```

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒPhotos.frameworkå¯¼è‡´AppKitè¢«åŠ è½½ï¼Œæˆ‘æ‰¾åˆ°çš„å”¯ä¸€ä¿®å¤æ˜¯åˆ é™¤ç…§ç‰‡åŠå…¶åœ¨åº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å¼•ç”¨ã€‚ ï¼ˆæˆ‘ä»¬ä½¿ç”¨å®ƒæ¥ä¸ºå›¾åƒæ³¨é‡Šé€‰æ‹©å›¾åƒã€‚ä½†æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¬¡è¦åŠŸèƒ½ï¼Œæ²¡æœ‰å®ƒï¼Œåº”ç”¨å°†è¿è¡Œè‰¯å¥½ã€‚ï¼‰

```shell
otool -L /System/Library/Frameworks/Photos.framework/Photos

/System/Library/Frameworks/Photos.framework/Photos:
  /System/Library/Frameworks/Photos.framework/Versions/A/Photos
  /System/Library/Frameworks/AVFoundation.framework/Versions/A/AVFoundation
  /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation
  /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit
  (output shortened)
```

ä»¥ä¸‹æ˜¯PDF Vieweråœ¨Macä¸Šçš„å±•ç¤ºã€‚æ–‡ä»¶é€‰æ‹©å™¨æ¦‚å¿µä¸æ˜¯æˆ‘ä»¬å°†åœ¨macOSä¸Šæä¾›çš„ä¸œè¥¿ï¼Œä½†æ˜¯å¯¹äºé»‘å®¢æ¥è¯´å®ƒæ˜¯å¯ä»¥çš„ï¼Œå¹¶ä¸”å®ƒç¡®å®å¾ˆå¥½ç”¨ï¼ŒåŒ…æ‹¬æ·»åŠ æ–°æ–‡ä»¶æ—¶çš„ç›®å½•è§‚å¯Ÿå™¨ï¼š



<video src="https://pspdfkit.com/images/blog/2018/marzipan-iosmac/PDFViewer-iOSMac-f9005ebc.mp4" width="100%" autoplay="" playsinline="" muted=""></video>



## åšä¸ªæ›´å¥½çš„Macå…¬æ°‘

çœ‹çœ‹å·¥å…·æ ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåšå¾—è¿˜ä¸å¤Ÿã€‚è¦æˆä¸ºä¸€åä¼˜ç§€çš„Macå…¬æ°‘æ„å‘³ç€æˆ‘ä»¬ä½¿ç”¨åŸç”Ÿå·¥å…·æ ï¼Œå°±åƒAppleçš„Homeåº”ç”¨ã€‚ä¸ºäº†äº†è§£è¿™æ˜¯å¦‚ä½•å®Œæˆçš„ï¼Œæˆ‘é€šå¸¸ä¼šä½¿ç”¨IDAæˆ–Hopperè¿›è¡Œæ·±åº¦æŒ–æ˜ - ä¸¤è€…éƒ½éå¸¸é€‚åˆåœ¨Appleçš„åº”ç”¨ç¨‹åºä¸­è¿›è¡Œæ‹†è§£å’Œçª¥è§†ã€‚é€šè¿‡åœ¨Hopperä¸­æ‰“å¼€Homeåº”ç”¨ç¨‹åºå¹¶æœç´¢â€œå·¥å…·æ â€ï¼Œå¯ä»¥è½»æ¾æ‰¾åˆ°è´Ÿè´£çš„ç±»ï¼š

```swift
class iOSMacToolbarController {
    init() {
        print("iOSMac Marzipan extensions initializing.")

        guard (NSClassFromString("_UIWindowToolbarButtonItem") != nil) else {
            return }

        let titleButton = _UIWindowToolbarButtonItem(identifier: "com.pspdfkit.viewer.test")
        titleButton?.title = "A button"

        guard let toolbarController = UIApplication.shared.keyWindow!.
              value(forKey: "_windowToolbarController") as? _UIWindowToolbarController else {
            return
        }

        toolbarController.itemIdentifiers = ["com.pspdfkit.viewer.test"]
        toolbarController.templateItems = [titleButton]

        print("iOSMac extension initialized.")
    }
}
```

![img](https://pspdfkit.com/images/blog/2018/marzipan-iosmac/UIKitCore-linkerError-093c79e4.png)



å¥½çš„ï¼Œæ‰€ä»¥è¿™å¹¶ä¸å¥‡æ€ªã€‚é“¾æ¥å™¨ä¸å–œæ¬¢æˆ‘ä»¬åœ¨è¿™é‡Œå£°æ˜ç±»ä½†ä¸æä¾›å®ç°ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯iOS UIKitçš„ä¸€éƒ¨åˆ†ã€‚è¿™ä¸ªèŠ±äº†æˆ‘ä¸€æ®µæ—¶é—´ï¼Œä½†å½“ç„¶æ¯ä¸ªé—®é¢˜éƒ½æœ‰è§£å†³æ–¹æ¡ˆã€‚è®¸å¤šå¹´å‰ï¼ŒAppleä¸ºç±»æ·»åŠ äº†å¼±è¿æ¥ï¼Œæ•´ä¸ªæ¡†æ¶å¯èƒ½å¾ˆå¼±ã€‚ç°åœ¨ï¼Œæˆ‘å¯ä»¥å°†å®ƒæå–åˆ°ä¸€ä¸ªæ¡†æ¶ä¸­å¹¶å®Œæˆå®ƒï¼Œä½†æˆ‘ä»¬å¸Œæœ›åœ¨è¿™é‡Œå¿«é€Ÿå¾—åˆ°ä¸€äº›ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæ˜¯æ¯ä¸ªç±»çš„å¼±é“¾æ¥ã€‚ è¿™æŒ‡ç¤ºç¼–è¯‘å™¨å¼±é“¾æ¥æŒ‡å®šçš„ç±»ã€‚ç°åœ¨å®ƒé“¾æ¥ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è¿è¡Œå§ï¼

![img](https://pspdfkit.com/images/blog/2018/marzipan-iosmac/weak-link-class-96970ac8.png)



## åˆ°è¿™é‡Œä¸å®¹æ˜“å•Š

è¿è¡Œæ—¶ä¼¼ä¹å¹¶ä¸é«˜å…´è¿™é‡Œæ²¡æœ‰symbolã€‚æˆ‘ä»¬å‘Šè¯‰é“¾æ¥å™¨å¯èƒ½æ²¡æœ‰å¯ç”¨çš„ä¸œè¥¿ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å‘Šè¯‰è¿è¡Œæ—¶ã€‚æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ è¿™æŒ‡ç¤ºç¼–è¯‘å™¨å¼±é“¾æ¥æŒ‡å®šçš„ç±»ã€‚ç°åœ¨å®ƒé“¾æ¥ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬è¿è¡Œå§ï¼

```shell
dyld: Symbol not found: _OBJC_CLASS_$__UIWindowToolbarButtonItem

  Referenced from: /Users/steipete/Library/Developer/CoreSimulator/Devices/43869E4F-C148-4D80-9E85-82466FAA8FED/data/Containers/Bundle/Application/6AFDFACD-0CD8-46FA-9F91-75B67B7A78F9/ViewerMac.app/ViewerMac

  Expected in: flat namespace
```



## å¼±é“¾æ¥å¤´

ä½¿ç”¨weak-importå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å‘Šè¯‰è¿è¡Œæ—¶æ–¹æ³•å¯èƒ½ä¸å¯ç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä»¬è¢«è§£æä¸ºnilï¼š

```shell
__attribute__((weak_import)) @interface _UIWindowToolbarItem : NSObject
```

çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:



<video src="https://pspdfkit.com/images/blog/2018/marzipan-iosmac/toolbar-button-action-2dcdf1c9.mp4" width="100%" autoplay="" playsinline="" muted=""></video>



## ç¦åˆ©ï¼šæŸ¥çœ‹è§†å›¾å±‚çº§

è™½ç„¶æˆ‘æ²¡æœ‰åŠæ³•è§¦å‘Xcodeçš„è§†å›¾è°ƒè¯•å™¨ï¼Œä½†[Vlas Voloshin](https://twitter.com/argentumko)çš„è¿™æ¬¡[æ¼”è®²](https://www.youtube.com/watch?v=EpUnke2yDug)æåˆ°äº†Revealçš„å·¥ä½œåŸç†ã€‚è™½ç„¶åæ¥æŸäº›æµ‹è¯•ç‰ˆä¸­å¯¹Mojaveçš„æ›´æ”¹é˜»æ­¢äº†åŠ è½½RevealæœåŠ¡å™¨ï¼Œä½†Itty Bitty Appsçš„ä¼˜ç§€å›¢é˜Ÿæ›´åŠ åŠªåŠ›ï¼Œå¹¶ä½¿ä»–ä»¬çš„v18ç‰ˆæœ¬ä¸iOSMacå¹³å°å…¼å®¹ã€‚è°ƒè¯•å™¨æ§åˆ¶å°ä¸­çš„ç®€å•æ˜¾ç¤º **load -a** å°†èµ·åˆ°ä½œç”¨ã€‚



##  æ€»ç»“

å°†iOSåº”ç”¨ç¨‹åºç§»æ¤åˆ°Macæ˜¯å¤šä¹ˆä»¤äººå…´å¥‹çš„äº‹ï¼Œè€Œä¸”ä½¿ç”¨ğŸçš„æ–°iOSMacå¹³å°æ¯”ä»¥å¾€æ›´å®¹æ˜“ã€‚åªéœ€å‡ ä¸ªæŠ€å·§ï¼Œå°±å¯ä»¥åœ¨ä¸åˆ°ä¸€å¤©çš„æ—¶é—´å†…ç§»æ¤æ•´ä¸ªå¤§å‹å¤æ‚çš„åº”ç”¨ç¨‹åºã€‚å¦‚ä½•ä¸ºæ‚¨çš„ä¸‹ä¸€ä¸ª'å®éªŒå‘¨äº”'æˆ–Hackathoné¡¹ç›®é€‰æ‹©æ­¤é¡¹ç›®ï¼Ÿåœ¨Twitterä¸Šping [@steipete](https://twitter.com/steipete)å¹¶å‘æˆ‘ä»¬å±•ç¤ºä½ çš„ç»“æœ - è®©[Marzipandemic](https://twitter.com/rgriff/status/1004405013462933504)å¼€å§‹å§ï¼